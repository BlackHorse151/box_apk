name: Build APKs

on:
  push:
    branches:
      - master
      - dev
    paths-ignore:
      - "docs/**"
      - "README.md"
  pull_request:
    branches:
      - master
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get tags
      id: get_head
      run: |
        echo "head=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

    - uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: 17

    - uses: gradle/gradle-build-action@v2
      with:
        gradle-home-cache-cleanup: true

    - name: Build Release APK
      run: ./gradlew app:assembleRelease

    - name: Display files in directory
      run: |
        ls app/build/outputs/apk/release

    - uses: r0adkll/sign-android-release@v1
      name: Sign app APK
      id: sign_apks
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: ${{ secrets.SIGNING_KEY }}
        alias: ${{ secrets.ALIAS }}
        keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}

    - name: Rename Apks
      run: |
        mkdir -p APKs
        mv ${{ steps.sign_apks.outputs.signedReleaseFile }} APKs/box-manager-${{ steps.get_head.outputs.head }}-prerelease.apk

    - uses: actions/upload-artifact@v2
      with:
        name: signed_apps
        path: APKs

    - name: Delete current Prerelease-alpha assets
      if: ${{ github.ref_name == 'master' && github.event_name != 'pull_request' }}
      uses: andreaswilli/delete-release-assets-action@v2.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        tag: Prerelease-alpha
        deleteOnlyFromDrafts: false

    - name: Tag Repo
      if: ${{ github.ref_name == 'master' && github.event_name != 'pull_request' }}
      uses: richardsimko/update-tag@v1
      with:
        tag_name: Prerelease-alpha
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Prerelease-alpha
      if: ${{ github.ref_name == 'master' && github.event_name != 'pull_request' }}
      uses: softprops/action-gh-release@v1
      with:
        tag: ${{ github.ref_name }}
        tag_name: Prerelease-alpha
        files: APKs/*
        prerelease: true
        generate_release_notes: true

    
